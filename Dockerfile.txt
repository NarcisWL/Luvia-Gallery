# Build Stage
FROM node:18-alpine as build
WORKDIR /app

# Copy dependency definitions
COPY package*.json ./
RUN npm install

# Copy all project files
COPY . .

# --- FIX STRUCTURE FOR REACT-SCRIPTS ---
# The project files are in the root, but react-scripts expects 'src' and 'public' folders.
# We restructure them before building.

# 1. Prepare directories
RUN mkdir -p public src

# 2. Move static assets to public
RUN if [ -f index.html ]; then mv index.html public/; fi && \
    if [ -f metadata.json ]; then mv metadata.json public/; fi

# 3. Move source code to src
# We move .tsx, .ts files and component directories.
# We verify files exist to avoid errors if the structure changes slightly.
RUN mv *.tsx src/ 2>/dev/null || true && \
    mv *.ts src/ 2>/dev/null || true && \
    mv components src/ 2>/dev/null || true && \
    mv utils src/ 2>/dev/null || true

# ---------------------------------------

# Build the React application
RUN npm run build

# Production Stage
FROM node:18-alpine
WORKDIR /app

# Install production dependencies only
COPY package*.json ./
RUN npm install --production

# Copy built assets from build stage
COPY --from=build /app/build ./build

# Copy server script (Assuming server.js is in the project root)
COPY server.js ./

# Create a placeholder for the config file
RUN touch lumina-config.json

EXPOSE 80
CMD ["node", "server.js"]