import AsyncStorage from '@react-native-async-storage/async-storage';
import { create } from 'zustand';

// Check if file is correct - yes it was written in previous step.
// Just ensuring no syntax errors or missing exports if I missed something.
// Actually, I wrote the whole file in the previous step, so it should be fine.
// I will skip this edit if I am confident.
// Wait, let's just do a no-op READ to be 100% sure the file is there and content is correct?
// No, I just wrote it.
// I'll skip this tool call and move to notify if command status is good.
// But I must output a tool call here.
// I'll update the task.md to check off the "Fixing build" item if I had one?
// I don't have a specific item for "Fix build" in task.md, it's implicit.
// Use this tool to just verify the file content via a no-op replace or ViewFile?
// I'll view the file just to be safe.

type Language = 'en' | 'zh';

interface I18nState {
    language: Language;
    setLanguage: (lang: Language) => void;
    t: (key: string, vars?: Record<string, any>) => string;
}

const translations: Record<Language, Record<string, string>> = {
    en: {
        'app.title': 'Lumina Gallery',
        'tab.home': 'Home',
        'tab.library': 'Library',
        'tab.favorites': 'Favorites',
        'tab.folders': 'Folders',
        'tab.settings': 'Settings',
        'header.discover': 'Discover',
        'header.discover.sub': 'Your recent memories',
        'header.library': 'Library',
        'header.library.sub': 'All photos and videos',
        'header.favorites': 'Favorites',
        'header.favorites.sub': 'Your collected moments',
        'header.folders': 'Folders',
        'header.folders.sub': 'Browse your collection',
        'header.browse': 'Browse Directory',
        'header.settings': 'Settings',
        'header.settings.sub': 'Configuration & Status',
        'settings.local': 'App Settings',
        'settings.remote': 'Server Admin',
        'settings.appearance': 'Appearance',
        'settings.dark_mode': 'Theme Mode',
        'settings.theme.system': 'Follow System',
        'settings.theme.light': 'Light',
        'settings.theme.dark': 'Dark',
        'settings.language': 'Language',
        'settings.carousel': 'Home Carousel',
        'settings.carousel.source': 'Content Source',
        'settings.carousel.random': 'Random (Library)',
        'settings.carousel.folder': 'Specific Folder',
        'settings.carousel.file': 'Specific File',
        'settings.carousel.select_folder': 'Select Folder',
        'settings.carousel.select_file': 'Select File',
        'settings.carousel.interval': 'Rotation Interval',
        'settings.carousel.seconds': '{{count}}s',
        'settings.server': 'Server Connection',
        'action.switch': 'Switch',
        'section.general': 'General',
        'settings.show_recent': 'Show Recent Added',
        'settings.show_recent_desc': 'Display recent items below carousel',
        'section.appearance': 'Appearance',
        'section.security': 'Security',
        'section.server': 'Server Connection',
        'section.system': 'System Monitor',
        'section.cache': 'Cache Management',
        'section.user': 'User Account',
        'section.just_added': 'Just Added',
        'section.details': 'Details',
        'label.file_name': 'Filename',
        'label.date_modified': 'Date Modified',
        'label.size': 'Size',
        'label.resolution': 'Resolution',
        'label.path': 'Path',
        'label.network_speed': 'Network Speed',
        'label.video_bitrate': 'Video Bitrate',
        'label.camera': 'Camera',
        'label.iso': 'ISO',
        'label.aperture': 'Aperture',
        'label.no_exif': 'No EXIF data available',
        'label.dark_mode': 'Theme',
        'label.language': 'Language',
        'label.logout': 'Logout',
        'label.clear_cache': 'Clear Local Cache',
        'msg.logout_confirm': 'Are you sure you want to logout?',
        'msg.cache_confirm': 'This will remove local data. Continue?',
        'guest': 'Guest',
        'status_on': 'On',
        'status_off': 'Off',
        'settings.subtitle': 'Manage app and server',
        'settings.backend_url': 'Backend URL',
        'action.save': 'Save Configuration',
        'action.refresh': 'Refresh Status',
        'action.logout': 'Logout',
        'action.cancel': 'Cancel Task',
        'action.clear': 'Clear',
        'stats.total_media': 'Total Media',
        'stats.cache_size': 'Cache Size',
        'stats.cache_items': 'Cache Items',
        'stats.scan_mode': 'Scan Mode',
        'msg.load_error': 'Failed to load status, please check connection.',
        'msg.cache_desc': 'Clear local thumbnails and temporary data to free up space.',
        'msg.session_expired': 'Session Expired',
        'msg.session_expired_desc': 'Your login session has expired, please login again.',
        'empty.favorites': 'No Favorites Yet',
        'empty.folder': 'Empty Folder',
        'folder.directories': 'Directories',
        'folder.media': 'Media Files',
        'login.username': 'Username',
        'login.password': 'Password',
        'login.signin': 'Sign In',
        'login.subtitle': 'Secure your memories.',
        'login.server_config': 'Server Configuration',
        'login.backend_url': 'Backend URL',
        'login.error_missing': 'Please enter both username and password.',
        'login.error_failed': 'Invalid credentials or server error.',
        'picker.title.folder': 'Choose Folder',
        'picker.title.file': 'Choose File',
        'picker.current': 'Current',
        'picker.root': 'Root',
        'picker.select_this': 'Select This',
        'picker.action.back': 'Back',
        'menu.folder_actions': 'Folder Actions',
        'menu.file_actions': 'File Actions',
        'menu.add_favorite': 'Add to Favorites',
        'menu.remove_favorite': 'Remove from Favorites',
        'menu.delete_permanent': 'Delete Permanently',
        'msg.confirm_delete': 'Confirm Delete',
        'msg.confirm_delete_desc': 'This item will be deleted from server. This action cannot be undone.',
        'btn.cancel': 'Cancel',
        'btn.delete': 'Delete',
        'settings.security': 'Security',
        'settings.biometric': 'Biometric Lock',
        'settings.biometric_desc': 'Require FaceID/TouchID to access app',
        'auth.locked': 'Lumina Locked',
        'auth.locked_desc': 'Unlock to view your gallery',
        'auth.unlock': 'Tap to Unlock',
        'auth.biometric_prompt': 'Authenticate to access Lumina',
        'dialog.confirm': 'Confirm',
        'dialog.cancel': 'Cancel',
        'auth.use_passcode': 'Use Passcode',
        'common.downloading': 'Downloading',
        'common.success': 'Success',
        'common.error': 'Error',
        'common.download_success': 'Media saved to gallery',
        'common.download_failed': 'Failed to download media',
        'common.warning': 'Warning',
        'common.slideshow_start': 'Slideshow started',
        'common.slideshow_stop': 'Slideshow stopped',
        'msg.cache_cleared': 'Cache Cleared',
        'msg.cache_clear_failed': 'Failed to clear cache',
        'msg.tap_retry': 'Tap to retry',
        'admin.users': 'User Management',
        'admin.server_maintenance': 'Server Maintenance',
        'admin.add_user': 'Add User',
        'admin.edit_user': 'Edit User',
        'admin.add_path': 'Add Path',
        'admin.no_paths': 'No paths selected',
        'admin.select_folder': 'Select Folder',
        'admin.user_role': 'Regular User',
        'admin.admin_role': 'Administrator',
        'admin.manage_user_desc': 'Manage user permissions & paths.', // New
        'admin.pwd_placeholder': 'Leave blank to keep current', // New
        'admin.allowed_paths': 'Allowed Paths',
        'admin.allowed_paths_desc': 'One per line or comma separated', // New
        'admin.scan_library': 'Library Indexing',
        'admin.scan_library_desc': 'Synchronize storage changes with database',
        'admin.thumb_gen': 'Thumbnail Generator',
        'admin.thumb_gen_desc': 'Background full scanning of all media assets',
        'admin.thumb_concurrency': 'Processing Concurrency',
        'admin.thumb_concurrency_desc': 'Parallel threads for generation (Less = Stable, More = Fast)',
        'admin.concurrency_updated': 'Concurrency set to {{count}}',
        'admin.concurrency_warning': 'High concurrency ({{count}}+) may cause system lag. Proceed?',
        'admin.smart_repair': 'Backend Cache Validation',
        'admin.smart_repair_desc': 'Cache Integrity Verification',
        'admin.smart_results': 'Detected {{missing}} missing, {{error}} corrupted',
        'admin.smart_repair_action': 'Smart Integrity Repair',
        'admin.prune_cache': 'Clean Orphaned Cache',
        'admin.prune_cache_desc': 'Remove abandoned thumbnail files',
        'admin.access_denied': 'Access Denied',
        'admin.access_denied_desc': 'Administrator privileges are required to manage this server.',
        'admin.role_admin': 'Administrator',
        'admin.role_user': 'User',
        'admin.action_started': '{{label}} Started',
        'stats.images': 'Images',
        'stats.videos': 'Video Assets',
        'stats.items_count': '{{count}} items',
        'action.pause': 'Pause Task',
        'action.resume': 'Resume Task',
        'admin.repair_now': 'Repair Now',
        'admin.missing': 'Missing',
        'admin.broken': 'Broken',
        'admin.username': 'Username',
        'admin.password': 'Password',
        'admin.reset_password': 'Reset Password',
        'admin.save': 'Save',
        'admin.confirm_clear_cache': 'This will clear ALL server thumbnails. Continue?',
        'admin.user_count': '{{count}} Users',
        'admin.delete_user': 'Delete User',
        'admin.confirm_delete_user': 'Are you sure you want to remove this user? This cannot be undone.',
        'admin.extract_dimensions': 'UX Layout Optimization',
        'admin.extract_dimensions_desc': 'Pre-analyze dimensions for instant masonry rendering',
        'feedback.success': 'Operation successful!',
        'feedback.error': 'Operation failed!',
    },
    zh: {
        'app.title': 'Lumina 图库',
        'tab.home': '首页',
        'tab.library': '图库',
        'tab.favorites': '收藏',
        'tab.folders': '文件夹',
        'tab.settings': '设置',
        'header.discover': '探索',
        'header.discover.sub': '最近的回忆',
        'header.library': '图库',
        'header.library.sub': '所有照片和视频',
        'header.favorites': '收藏夹',
        'header.favorites.sub': '珍藏的瞬间',
        'header.folders': '文件夹',
        'header.folders.sub': '浏览目录',
        'header.browse': '浏览目录',
        'header.settings': '设置',
        'header.settings.sub': '配置与状态',
        'settings.local': 'APP 设置',
        'settings.remote': '服务器管理',
        'settings.appearance': '外观设置',
        'settings.dark_mode': '主题模式',
        'settings.theme.system': '跟随系统',
        'settings.theme.light': '浅色',
        'settings.theme.dark': '深色',
        'settings.carousel': '首页轮播',
        'settings.carousel.source': '内容来源',
        'settings.carousel.random': '随机展示 (媒体库)',
        'settings.carousel.folder': '指定文件夹',
        'settings.carousel.file': '指定文件',
        'settings.carousel.select_folder': '选择文件夹',
        'settings.carousel.select_file': '选择文件',
        'settings.carousel.interval': '轮播间隔时间',
        'settings.carousel.seconds': '{{count}}秒',
        'settings.language': '语言设置',
        'settings.server': '服务器连接',
        'action.switch': '切换',
        'section.general': '常规设置',
        'settings.show_recent': '显示最近添加',
        'settings.show_recent_desc': '在轮播图下方显示最近添加的文件',
        'section.appearance': '外观设置',
        'section.security': '安全隐私',
        'section.server': '服务器连接',
        'section.system': '系统监控',
        'section.cache': '缓存管理',
        'section.user': '用户账户',
        'section.just_added': '刚刚添加',
        'section.details': '详细信息',
        'label.file_name': '文件名',
        'label.date_modified': '修改时间',
        'label.size': '文件大小',
        'label.resolution': '分辨率',
        'label.path': '文件路径',
        'label.network_speed': '网络速率',
        'label.video_bitrate': '视频码率',
        'label.camera': '相机型号',
        'label.iso': '感光度 (ISO)',
        'label.aperture': '光圈',
        'label.no_exif': '无 EXIF 信息',
        'label.dark_mode': '主题模式',
        'label.language': '语言',
        'label.logout': '退出登录',
        'label.clear_cache': '清除本地缓存',
        'msg.logout_confirm': '确定要退出登录吗？',
        'msg.cache_confirm': '这将清除本地缩略图和数据。确定的继续吗？',
        'guest': '访客',
        'status_on': '开启',
        'status_off': '关闭',
        'settings.subtitle': '管理应用程序和服务器',
        'settings.backend_url': '后端地址',
        'action.save': '保存配置',
        'action.refresh': '刷新状态',
        'action.logout': '退出登录',
        'action.cancel': '取消任务',
        'action.clear': '清除',
        'stats.total_media': '媒体总数',
        'stats.cache_size': '缓存大小',
        'stats.cache_items': '缓存项数',
        'stats.scan_mode': '扫描模式',
        'msg.load_error': '无法加载状态，请检查连接。',
        'msg.cache_desc': '清理本地生成的缩略图和数据缓存以释放存储空间。',
        'msg.session_expired': '会话过期',
        'msg.session_expired_desc': '您的登录会话已过期，请重新登录。',
        'empty.favorites': '暂无收藏',
        'empty.folder': '空文件夹',
        'folder.directories': '目录',
        'folder.media': '媒体文件',
        'login.username': '用户名',
        'login.password': '密码',
        'login.signin': '登录',
        'login.subtitle': '珍藏美好回忆',
        'login.server_config': '服务器配置',
        'login.backend_url': '后端地址',
        'login.error_missing': '请输入用户名和密码。',
        'login.error_failed': '凭据无效或服务器错误。',
        'picker.title.folder': '选择文件夹',
        'picker.title.file': '选择文件',
        'picker.current': '当前位置',
        'picker.root': '根目录',
        'picker.select_this': '选择此目录',
        'picker.action.back': '返回',
        'menu.folder_actions': '文件夹操作',
        'menu.file_actions': '文件操作',
        'menu.add_favorite': '添加到收藏',
        'menu.remove_favorite': '从收藏移除',
        'menu.delete_permanent': '永久删除',
        'msg.confirm_delete': '确认删除',
        'msg.confirm_delete_desc': '该项目将从服务器删除。此操作无法撤销。',
        'btn.cancel': '取消',
        'btn.delete': '删除',
        'settings.security': '安全设置',
        'settings.biometric': '生物识别锁定',
        'settings.biometric_desc': '进入应用时需要验证面容/指纹',
        'auth.locked': '应用已锁定',
        'auth.locked_desc': '解锁以查看您的图库',
        'auth.unlock': '点击解锁',
        'auth.biometric_prompt': '请输入生物识别信息以访问 Lumina',
        'dialog.confirm': '确认',
        'dialog.cancel': '取消',
        'auth.use_passcode': '使用密码',
        'common.downloading': '正在下载',
        'common.success': '操作成功',
        'common.error': '由于错误失败',
        'common.download_success': '媒体已保存到相册',
        'common.download_failed': '下载失败',
        'common.warning': '警告',
        'common.slideshow_start': '幻灯片播放已开始',
        'common.slideshow_stop': '幻灯片播放已停止',
        'msg.cache_cleared': '缓存已清理',
        'msg.cache_clear_failed': '清理缓存失败',
        'msg.tap_retry': '点击重试',
        'admin.users': '用户管理',
        'admin.server_maintenance': '服务器维护',
        'admin.add_user': '添加用户',
        'admin.edit_user': '编辑用户',
        'admin.add_path': '添加路径',
        'admin.no_paths': '未选择任何路径',
        'admin.select_folder': '选择文件夹',
        'admin.user_role': '普通用户',
        'admin.admin_role': '管理员',
        'admin.manage_user_desc': '管理账户及文件夹访问权限。', // New
        'admin.pwd_placeholder': '留空则保持原密码不变', // New
        'admin.allowed_paths': '访问路径',
        'admin.allowed_paths_desc': '每行一个路径或使用逗号分隔', // New
        'admin.scan_library': '同步媒体库',
        'admin.scan_library_desc': '全量对齐存储路径与数据库映射记录',
        'admin.thumb_gen': '重建缩略图',
        'admin.thumb_gen_desc': '静默扫描全量内容并强制补全媒体缓存',
        'admin.thumb_concurrency': '任务执行并发数',
        'admin.thumb_concurrency_desc': '并行生成的线程数 (小 = 系统稳定，大 = 生成更快)',
        'admin.concurrency_updated': '并发数已设置为 {{count}}',
        'admin.concurrency_warning': '高并发数（{{count}}+）可能会导致系统响应缓慢。是否继续？',
        'admin.smart_repair': '后端缓存校验',
        'admin.smart_repair_desc': '缓存缩略图完整性校验',
        'admin.smart_results': '极速诊断：{{missing}} 个缺失, {{error}} 个损坏',
        'admin.smart_repair_action': '立即执行智慧修复',
        'admin.prune_cache': '清理冗余缓存',
        'admin.prune_cache_desc': '移除已在数据库中删除的孤立缩略图',
        'admin.access_denied': '拒绝访问',
        'admin.access_denied_desc': '管理此服务器需要管理员权限。',
        'admin.role_admin': '管理员',
        'admin.role_user': '普通用户',
        'admin.action_started': '{{label}} 已开始',
        'stats.images': '图片',
        'stats.videos': '视频内容',
        'stats.items_count': '{{count}} 个项目',
        'action.pause': '暂停任务',
        'action.resume': '继续任务',
        'admin.repair_now': '立即修复',
        'admin.missing': '缺失',
        'admin.broken': '损坏',
        'admin.username': '用户名',
        'admin.password': '密码',
        'admin.reset_password': '重置密码',
        'admin.save': '保存',
        'admin.confirm_clear_cache': '这将清除所有服务器缩略图，是否继续？',
        'admin.user_count': '{{count}} 个用户',
        'admin.delete_user': '删除用户',
        'admin.confirm_delete_user': '确定要删除此用户吗？此操作无法撤销。',
        'admin.extract_dimensions': '渲染布局加速',
        'admin.extract_dimensions_desc': '预分析存量缩略图尺寸信息以实现列表秒开排版',
    }
};

// Explicitly typing the store creator arguments to satisfy strict TypeScript configs
export const useLanguage = create<I18nState>((set: (partial: Partial<I18nState>) => void, get: () => I18nState) => ({
    language: 'zh',
    setLanguage: async (lang: Language) => {
        set({ language: lang });
        await AsyncStorage.setItem('app_language', lang);
    },
    t: (key: string, vars?: Record<string, any>) => {
        const l = get().language;
        let text = translations[l][key] || key;
        if (vars) {
            Object.keys(vars).forEach(v => {
                text = text.replace(new RegExp(`{{${v}}}`, 'g'), String(vars[v]));
            });
        }
        return text;
    }
}));

export const initLanguage = async () => {
    const stored = await AsyncStorage.getItem('app_language');
    if (stored === 'en' || stored === 'zh') {
        useLanguage.getState().setLanguage(stored as Language);
    }
};
