version: '3.8'

services:
  lumina-gallery:
    build:
      context: .
      dockerfile: Dockerfile.txt
    container_name: lumina-gallery
    restart: unless-stopped
    ports:
      - "3000:80"
    volumes:
      # Map your NAS media folders here.
      # You can map to subfolders of /media OR to arbitrary root folders.
      # If you map to root folders (e.g. /photos), add "/photos" to Library Scan Paths in settings.
      
      # Example 1: Standard /media mapping
      - ./media_test:/media
      
      # Example 2: Multiple Roots
      # - /volume1/family_photos:/photos
      # - /volume1/movies:/movies
      
      # Persistence for configuration - Mapped to a directory to avoid 'touch' requirements
      - ./data:/app/data
      
      # Persistence for generated thumbnails (Recommended for performance)
      - ./cache:/app/cache
    environment:
      - NODE_ENV=production
      # Default fallback root if no paths configured
      - MEDIA_ROOT=/media
      # NVIDIA GPU Support (Environment variables)
      # These variables tell the NVIDIA runtime what capabilities to expose.
      # They are harmless if the runtime is not used, but required if it is.
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    
    # -------------------------------------------------------------------------
    # GPU CONFIGURATION NOTE:
    # The error "could not select device driver nvidia" occurs if the host machine
    # does not have the NVIDIA Container Toolkit installed and configured.
    #
    # 1. If you DO NOT have an NVIDIA GPU or the toolkit installed:
    #    Keep the 'deploy' section commented out. The app will run in CPU mode.
    #
    # 2. If you DO have an NVIDIA GPU and want hardware acceleration:
    #    a. Install NVIDIA Container Toolkit on your host: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html
    #    b. Restart Docker daemon.
    #    c. Uncomment the 'deploy' section below.
    # -------------------------------------------------------------------------
    
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
